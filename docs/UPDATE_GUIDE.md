

## **SUES GPA Analyzer - 新功能需求与规划文档 (RPD)**

### **1. 文档概述**

* **项目名称:** SUES GPA Analyzer
* **版本:** v1.5 (暂定)
* **目的:** 本文档旨在为 `SUES GPA Analyzer` 规划两项核心新功能：**软件内更新机制** 和 **AI原生重修规划**。文档将详细描述功能需求、用户场景、技术实现方案、架构变更以及开发路线图，作为后续开发工作的核心指导。

### **2. 项目目标与价值**

* **提升用户体验:** 引入无缝的软件内更新功能，免去用户手动下载安装包的繁琐步骤，确保用户能及时使用到最新的功能和修复。
* **智能化决策支持:** 集成智谱 GLM-4.6 大语言模型，将现有的手动重修规划器升级为由 AI 驱动的智能分析工具，为学生提供数据驱动、个性化且更优的学业提升建议，创造核心功能亮点。
* **增强产品竞争力:** 通过 AI Native 功能的引入，使应用从一个“数据可视化工具”转变为一个“智能学业规划助手”，显著提升产品价值。

### **3. 功能需求详述**

#### **功能模块 A：软件内更新机制**

* **用户故事:**
    * 作为用户，我希望应用能在启动时自动检查是否有新版本，并在发现新版本时提示我。
    * 作为用户，我希望可以在应用的“关于”或“设置”页面手动触发更新检查。
    * 作为用户，我希望能清晰地看到更新的下载进度，并在下载完成后一键重启安装。

* **功能需求:**
    1.  **自动更新检查:** 应用启动后，在后台静默检查 GitHub Releases，判断是否存在新版本。
    2.  **手动更新检查:** 在 UI 中提供一个明确的按钮（例如在设置或关于页面），用户点击后可立即触发更新检查。
    3.  **更新提示:**
        * 当检测到新版本时，应通过一个非侵入式的方式通知用户（如：Toast通知、小红点徽章）。
        * 弹窗或专门的更新面板应清晰展示当前版本和最新版本号，并附上更新日志（Release Notes）。
    4.  **下载与安装:** 用户同意更新后，应用在后台下载新版本安装包。UI 需实时显示下载进度。下载完成后，提示用户“立即重启并更新”。
    5.  **无缝安装:** 用户点击后，应用应能自动退出并启动安装程序，完成更新。

* **技术实现方案:**
    * **核心库:** 采用 `electron-updater` 库，该库与 Electron Forge 良好集成，能很好地处理与 GitHub Releases 的通信、下载和静默安装流程。
    * **主进程 (`main.js`):**
        * 集成 `electron-updater` 的 `autoUpdater` 模块。
        * 在应用启动时调用 `autoUpdater.checkForUpdatesAndNotify()`。
        * 监听 `update-available`, `update-not-available`, `download-progress`, `update-downloaded`, `error` 等事件，并通过 IPC 通道将这些状态实时同步给渲染进程。
        * 新增 IPC Handler，如 `check-for-updates` (由渲染进程调用) 和 `restart-and-install`。
    * **渲染进程 (Frontend):**
        * 创建一个新的 React 组件，例如 `UpdatePanel.jsx`。
        * 该组件负责展示版本信息、更新日志和当前更新状态（如“正在检查更新...”、“已是最新版本”、“下载中... xx%”）。
        * 通过 `preload.js` 暴露的 IPC 接口，向主进程发送指令并接收来自主进程的更新状态事件，然后更新 UI。

---

#### **功能模块 B：AI 原生重修规划 (集成智谱 GLM-4.6)**

* **用户故事:**
    * 作为用户，我希望输入我的智谱 API Key 并安全保存，以便使用 AI 功能。
    * 作为用户，我希望在重修规划器中点击一个按钮，就能让 AI 分析我所有的课程成绩，并为我推荐一个最优的重修方案。
    * 作为用户，我希望 AI 的建议是具体的、可执行的，例如：明确指出应该重修哪些课程、预期的 GPA 提升效果，并解释为什么这么推荐。

* **功能需求:**
    1.  **API Key 管理:**
        * 在应用的设置界面提供输入框，让用户配置自己的智谱 API Key。
        * API Key 必须被安全地存储在用户的操作系统钥匙串中，绝不能明文存储。
    2.  **AI 分析触发:**
        * 在现有的 `RetakePlanner.jsx` 界面中，增加一个醒目的 "AI 智能规划" 按钮。
        * 用户点击后，应用应显示加载状态，防止用户重复点击。
    3.  **智能分析与建议:**
        * AI 需要基于用户的全部课程数据（尤其是已通过但绩点不高的课程和不及格的课程）进行分析。
        * 分析结果应以清晰、结构化的方式呈现，至少包含：
            * **推荐重修课程列表:** 按优先级排序。
            * **预期结果:** 重修这些课程并达到某个预设分数（如85分/绩点3.5）后，总 GPA 预计能提升到多少。
            * **决策理由:** 对为什么推荐这些课程给出简短、易懂的解释（例如：“重修此门课程学分权重高，对总 GPA 影响最大”）。
    4.  **错误处理:** 当 API 请求失败（如网络问题、Key 无效、余额不足）时，向用户显示友好的错误提示。

* **技术实现方案:**
    * **API Key 存储:**
        * **主进程:** 使用 `keytar` 库来安全地存取 API Key。这与当前存储用户密码的方案一致，可以复用。
        * **IPC:** 新增 `save-api-key` 和 `load-api-key` 的 IPC Handler。
    * **后端 API 调用 (主进程):**
        * **核心原则:** **API 调用和 Key 的管理必须严格限制在主进程中**，绝不能在渲染进程中处理，以防 API Key 泄露。
        * 创建一个新的工具模块，如 `src/utils/aiService.js`。
        * 该模块负责：
            1.  从 `keytar` 读取 API Key。
            2.  接收从渲染进程通过 IPC 传来的完整课程数据。
            3.  **构建 Prompt:** 这是最关键的一步。需要设计一个高效的 Prompt，将用户的课程数据（CSV 格式或 JSON 格式）、GPA 计算规则（`加权 GPA = Σ(课程学分 × 课程绩点) / Σ(总学分)`）以及规划目标清晰地描述给 GLM-4.6 模型。
            4.  使用 `axios` 或 `node-fetch` 向智谱 API 端点 (`https://open.bigmodel.cn/api/paas/v4/chat/completions`) 发起请求。
            5.  解析返回的 JSON 结果，进行适当的格式化处理，然后通过 IPC 将结构化的建议返回给渲染进程。
    * **前端交互 (渲染进程):**
        * 修改 `RetakePlanner.jsx` 组件，增加 "AI 智能规划" 按钮和一个用于显示 AI 结果的区域。
        * 点击按钮时，调用 IPC 接口 (`invoke-ai-planner`)，将用户的课程数据发送到主进程。
        * 等待主进程返回结果，期间显示加载动画。
        * 收到结果后，将其解析并渲染到 UI 上，以卡片或列表的形式美观地展示给用户。

### **4. 架构变更与影响**

* **新增依赖:**
    * `dependencies`: `axios` (或 `node-fetch`) 用于 API 请求。
    * `devDependencies`: `electron-updater` 用于处理更新。
* **文件结构变更:**
    * **新增文件:**
        * `frontend/src/components/UpdatePanel.jsx`: 更新功能的 UI 面板。
        * `frontend/src/components/Settings.jsx` (或类似): 用于管理 API Key 和触发手动更新的设置页面。
        * `src/utils/aiService.js`: 封装与智谱 API 交互的逻辑。
    * **修改文件:**
        * `main.js`: 添加 `electron-updater` 初始化逻辑、新的 IPC Handlers (用于更新和 AI)。
        * `preload.js`: 暴露新的 IPC 通道。
        * `frontend/src/components/RetakePlanner.jsx`: 集成 AI 规划的触发按钮和结果展示区。
        * `package.json`: 添加新依赖，并可能需要在 `build` 配置中为 `electron-updater` 添加发布者信息（如 `publish` 字段）。

### **5. 开发路线图 (建议)**

1.  **Phase 1: 实现软件内更新机制 (预计 3-4 天)**
    * [ ] 步骤 1: 集成 `electron-updater` 并配置 `package.json`。
    * [ ] 步骤 2: 在主进程中添加更新检查和事件监听逻辑。
    * [ ] 步骤 3: 开发前端的 `UpdatePanel.jsx` 组件和 IPC 通信。
    * [ ] 步骤 4: 在 GitHub 创建一个测试 Release，进行端到端更新流程测试。

2.  **Phase 2: 实现 AI 原生重修规划 (预计 5-7 天)**
    * [ ] 步骤 1: 实现 API Key 的安全存储与读取 (`keytar` + IPC)。
    * [ ] 步骤 2: 开发设置页面 UI，用于用户输入和管理 Key。
    * [ ] 步骤 3: 在主进程中创建 `aiService.js`，实现与智谱 API 的通信。
    * [ ] 步骤 4: **核心任务:** 设计和调试 Prompt，确保 AI 理解 GPA 规则并能返回稳定、高质量的结构化数据。
    * [ ] 步骤 5: 开发 `RetakePlanner.jsx` 的前端交互逻辑，包括数据发送、加载状态和结果展示。
    * [ ] 步骤 6: 进行全面的功能测试和错误处理测试。

### **6. 风险与缓解措施**

* **风险:** 智谱 API 费用超出预期或服务不稳定。
    * **缓解:** 在 UI 中明确告知用户此功能需要使用自己的 API Key 并会产生费用。实现健壮的错误处理机制，在 API 不可用时优雅降级。
* **风险:** AI 返回的建议质量不稳定或格式混乱。
    * **缓解:**投入充足时间进行 Prompt Engineering。在主进程中对 AI 返回的数据进行严格的校验和解析，如果格式不符，则向用户返回提示信息，而不是直接展示错误数据。
* **风险:** `electron-updater` 在不同操作系统（尤其是 Windows 的代码签名）上配置复杂。
    * **缓解:** 严格遵循 `electron-updater` 的官方文档进行配置。为 Windows 和 macOS 分别进行打包和更新测试。

---