# AI 原生重修规划 - 功能实现与演进蓝图

## 1. 概述

本文档旨在为 `SUES GPA Analyzer` 的 **AI 原生重修规划** 功能提供一份详细的、可执行的实现指南，并探索其未来的演进方向，以最大化 AI 技术为用户带来的价值。

核心原则是：

*   **复用现有能力:** 尽可能利用项目中已有的函数和组件，避免重复开发。
*   **立足当下，展望未来:** 在实现核心需求（MVP）的基础上，设计一条清晰的路径，将工具从“重修规划器”逐步升级为“个性化智能学业顾问”。

---

## 2. 第一阶段：基础功能 (MVP) 实现方案

此阶段的目标是快速、稳健地集成大语言模型，实现智能化的重修建议功能。我们将严格遵循 `UPDATE_GUIDE.md` 的指导，并细化执行步骤。

### 步骤 1: API Key 安全管理 (复用 `keytar`)

*   **目标:** 为用户提供一个安全输入和存储其智谱 API Key 的界面。
*   **执行:**
    1.  **主进程 (`main.js`):**
        *   复用现有的 `keytar` 逻辑，该逻辑已用于安全存储用户密码。
        *   新增两个 IPC Handler：
            *   `save-api-key(apiKey)`: 使用 `keytar.setPassword(SERVICE_NAME_AI, username, apiKey)` 进行存储。注意：`SERVICE_NAME_AI` 应为一个新的服务名（如 `SUES_GPA_Analyzer_AI`），以和用户密码隔离。
            *   `load-api-key()`: 使用 `keytar.getPassword(SERVICE_NAME_AI, username)` 进行读取。
    2.  **渲染进程 (Frontend):**
        *   在 `frontend/src/components/Settings.jsx` 中，增加一个新的卡片（Card）组件，用于 API Key 管理。
        *   该组件包含一个 `TextField` 供用户输入 Key，一个 `Button` 用于保存。
        *   组件加载时，调用 `window.electronAPI.loadApiKey()` 填充现有 Key。
        *   点击保存时，调用 `window.electronAPI.saveApiKey(newApiKey)`。
        *   **UI 增强:** 对输入框中的 API Key 进行掩码处理（例如只显示前四位和后四位），提升安全性观感。

### 步骤 2: AI 服务核心逻辑 (主进程)

*   **目标:** 创建一个专门处理与 AI 模型交互的后端服务，确保 API Key 和 Prompt 构建逻辑不泄露到前端。
*   **执行:**
    1.  **创建 `src/utils/aiService.js`:**
        *   此模块将导出一个核心函数，例如 `getAIRetakePlan(coursesData)`。

    2.  **新增学期感知与约束 (New):**
        *   **目标:** 让 AI 的建议符合现实的开课时间。
        *   **实现:** 在 `aiService.js` 中，`getAIRetakePlan` 函数需要：
            *   **自动识别当前学期:**
                *   创建一个内部函数 `getCurrentSemester()`。
                *   通过 `new Date().getMonth()` 获取当前月份。
                *   9月至1月 (月份 8-11, 0) -> 返回 `{ "current": "第一学期", "next": "第二学期" }`。
                *   2月至6月 (月份 1-5) -> 返回 `{ "current": "第二学期", "next": "第一学期" }`。
                *   7月至8月 (月份 6, 7) -> 返回 `{ "current": "暑假", "next": "第一学期" }`。
            *   **将学期信息注入 Prompt:** 将识别出的 `current` 和 `next` 学期信息传递给 Prompt，作为 AI 规划的强约束。

    3.  **构建 Prompt (已更新):** 这是 AI 功能的灵魂。`getAIRetakePlan` 函数内部需要：
        *   **读取 Key:** 调用 `keytar` 读取已保存的 API Key。
        *   **格式化数据:** 将前端传来的 `coursesData` (JSON 数组) 转换为对 AI友好的格式（如 Markdown 表格或简化的 JSON 字符串），**确保 `course_semester` 字段包含在内**。
        *   **设计指令:** 创建一个结构清晰、指令明确的 Prompt。模板更新如下：

        ```
        你是一位专业的大学学业导师，特别熟悉上海工程技术大学的GPA计算规则和课程安排。

        **任务:**
        请根据以下学生的所有课程成绩，为他/她设计一个最优的重修方案，以最大化提升总加权GPA。

        **GPA计算规则:**
        - 加权 GPA = Σ(课程学分 × 课程绩点) / Σ(总学分)
        - 只有成绩通过的课程才计入总学分。
        - 绩点换算：90-100分=4.0, 85-89分=3.7, ... (以此类推)

        **重要约束:**
        1.  **当前学期:** 现在是 **{current_semester_string}**。
        2.  **规划目标:** 你的所有重修建议都必须是针对即将到来的 **{next_semester_string}**。
        3.  **课程可用性:** 你推荐的课程必须在 `{next_semester_string}` 有开设。请严格参考每门课程的 "course_semester" 字段。
            - `course_semester` 值为 '1' 或 '2' 等单独数字，代表只在该学期开设。
            - `course_semester` 值为 '(1,2)' 或 '(3,4)'，代表在这些连续的学期开设。
            - `course_semester` 值为 '--'，代表所有学期都开设。

        **学生课程数据:**
        {formatted_courses_data_with_semester}

        **输出要求:**
        请严格按照以下JSON格式返回你的建议，不要添加任何额外的解释或说明文字。返回的结果必须是一个可以直接被解析的JSON对象。

        {
          "recommendations": [
            {
              "course_name": "课程A",
              "reason": "该课程学分权重高，且在即将到来的{next_semester_string}开设，重修性价比最高。",
              "expected_gpa_impact": "+0.25"
            },
            ...
          ],
          "summary": "综合来看，按此方案在{next_semester_string}进行重修，并将推荐课程的成绩提升至85分以上，你的总GPA预计可以从当前的 {current_gpa} 提升至 {new_gpa}。"
        }
        ```
    4.  **API 调用:**
        *   使用已安装的 `axios` 库，向智谱 API (`https://open.bigmodel.cn/api/paas/v4/chat/completions`) 发起 POST 请求。
        *   实现错误处理机制，捕获网络问题、无效 Key、余额不足等错误，并返回一个结构化的错误信息。
    5.  **主进程 (`main.js`):**
        *   创建一个新的 IPC Handler `invoke-ai-planner`，它接收课程数据，调用 `aiService.js` 中的函数，并将结果（成功或失败）返回给渲染进程。

### 步骤 3: 前端交互与展示

*   **目标:** 在现有的重修规划器中无缝集成 AI 功能的触发和结果展示。
*   **执行:**
    1.  **修改 `frontend/src/components/RetakePlanner.jsx`:**
        *   **增加触发按钮:** 在界面顶部或一个醒目的位置，添加一个带有 AI 图标的按钮，文案为“AI 智能规划”。
        *   **管理加载状态:** 点击按钮后，应立即将其设为禁用状态，并显示加载动画（可复用项目已有的 `CircularProgress`），防止用户重复点击。
        *   **调用主进程:** 调用 `window.electronAPI.invokeAiPlanner(courseData)`。
    2.  **创建结果展示组件:**
        *   可以创建一个新的组件 `AIPlanDisplay.jsx`。
        *   该组件接收 AI 返回的 JSON 数据，并使用 `Card` 和 `Typography` 等现有组件，以美观、清晰的方式渲染每一条建议（课程名、理由、预期效果）和最终的总结。
        *   当 `RetakePlanner.jsx` 收到 AI 结果后，将数据显示出来。如果出错，则显示友好的错误提示。

---

## 3. 第二阶段：未来形态 - “个性化智能学业顾问”

在完成基础功能后，我们可以进一步释放 AI 的潜力，将工具演进为一个更强大、更主动的学业伙伴。

### 演进方向 1: 交互式目标设定与“What-If”分析

*   **形态:** 用户不再只是被动接收建议，而是可以主动设定目标。
*   **功能:**
    *   **目标输入:** 在 AI 规划器中增加一个输入框：“我期望达到的 GPA 是: [ 3.5 ]”。
    *   **反向规划:** AI 根据用户的目标，反向计算出达到该目标所需重修的课程组合和最低分数要求。
    *   **可视化模拟 (复用 `Charts.jsx`):** AI 生成的多种方案可以与图表功能联动。用户点击一个方案，`Charts.jsx` 可以动态渲染出一条“预测 GPA 趋势线”，直观展示遵循该建议后的学业轨迹变化。这极大地复用了现有图表能力，提升了价值。

### 演进方向 2: 多学期、长周期的学业规划

*   **形态:** 从单次的“重修建议”升级为连贯的“学业路径规划”。
*   **功能:**
    *   **规划周期设定:** 用户可以输入：“我计划在未来 [2] 个学期内完成重修，每学期不超过 [3] 门额外课程。”
    *   **智能分配:** AI 将综合考虑课程的优先级、学分、以及用户的负载意愿，将重修任务合理地分配到未来几个学期中。
    *   **结合课程表 (`scheduler.js`):** 如果 `scheduler.js` 具备排课功能，AI 生成的学期规划可以直接作为输入，帮助用户在学校的选课系统中提前占位，实现从“规划”到“执行”的闭环。

### 演进方向 3: 超越重修，提供选修课与发展建议

*   **形态:** 成为一个真正的“学业顾问”，而不仅仅是“补救工具”。
*   **功能:**
    *   **优势课程分析:** AI 分析用户成绩单，识别出用户表现优异的课程领域（例如“所有编程相关课程得分都很高”）。
    *   **选修课推荐:** 基于用户的优势领域和兴趣，推荐能够进一步强化这些优势的选修课或专业方向。
    *   **职业路径关联:** 用户可以输入期望的职业方向（如“数据分析师”），AI 可以结合该领域的通用要求，推荐需要加强的课程和建议达到的 GPA 水平。

---

## 4. 总结与路线图

我们将分阶段进行开发，确保每一步都为用户带来坚实的价值。

*   **Phase 1 (核心):** **实现基础的 AI 重修规划 (MVP)**。这是当前的首要任务，我们将按照本文第二部分的方案进行开发。
*   **Phase 2 (增强):** **实现交互式目标设定与 What-If 分析**。让用户拥有更高的自由度，并与图表功能深度整合。
*   **Phase 3 (扩展):** **实现多学期规划**。将工具的能力从“点”提升到“线”。
*   **Phase 4 (未来):** **探索“学业顾问”模式**。引入更广泛的数据（如全校课程目录、职业要求），实现终极价值。

通过这条路径，`SUES GPA Analyzer` 将从一个实用的 GPA 计算器，转变为一个不可或缺的、由 AI 驱动的个性化智能学业伙伴。